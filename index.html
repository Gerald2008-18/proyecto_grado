<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sistema de Atrasos - UEPDC</title>
  
  <!-- Favicon del colegio -->
  <link rel="icon" type="image/png" href="https://i.ibb.co/dwm03mTb/image-30.png" />

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Lucide (icons) -->
  <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/lucide.min.js"></script>

  <!-- jsQR (QR scanning) -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

  <style>
    html,body,#root { height: 100%; margin: 0; }
    
    /* Colores institucionales */
    :root {
      --primary-blue: #1976D2;
      --primary-blue-dark: #0D47A1;
      --primary-blue-light: #2196F3;
      --primary-yellow: #FFC107;
      --primary-yellow-dark: #FFA000;
      --primary-yellow-light: #FFD54F;
    }

    /* ANIMACIONES */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideIn {
      from { transform: translateX(-100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    @keyframes shimmer {
      0% { background-position: -1000px 0; }
      100% { background-position: 1000px 0; }
    }

    .animate-fadeIn {
      animation: fadeIn 0.5s ease-out;
    }

    .animate-slideIn {
      animation: slideIn 0.5s ease-out;
    }

    .animate-pulse-slow {
      animation: pulse 2s ease-in-out infinite;
    }

    .animate-bounce-slow {
      animation: bounce 2s ease-in-out infinite;
    }

    .animate-shimmer {
      animation: shimmer 2s linear infinite;
      background: linear-gradient(to right, #10b981 0%, #34d399 50%, #10b981 100%);
      background-size: 1000px 100%;
    }

    /* Hover effects */
    .hover-scale {
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .hover-scale:hover {
      transform: scale(1.05);
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }

    .hover-glow {
      transition: box-shadow 0.3s ease;
    }

    .hover-glow:hover {
      box-shadow: 0 0 20px rgba(255, 193, 7, 0.6);
    }

    .bg-institutional-blue { background-color: var(--primary-blue); }
    .bg-institutional-blue-dark { background-color: var(--primary-blue-dark); }
    .bg-institutional-yellow { background-color: var(--primary-yellow); }
    .text-institutional-blue { color: var(--primary-blue); }
    .text-institutional-yellow { color: var(--primary-yellow); }
    .border-institutional-blue { border-color: var(--primary-blue); }
    .border-institutional-yellow { border-color: var(--primary-yellow); }

    .file-upload-zone {
      border: 2px dashed #1976D2;
      transition: all 0.3s ease;
    }
    
    .file-upload-zone:hover {
      border-color: #FFC107;
      background-color: #FFFEF7;
      transform: scale(1.02);
    }

    .file-upload-zone.drag-over {
      border-color: #FFC107;
      background-color: #FFF9C4;
      transform: scale(1.05);
    }

    /* Logo responsive */
    .logo-container {
      width: 60px;
      height: 60px;
      transition: transform 0.3s ease;
    }

    .logo-container:hover {
      transform: rotate(5deg) scale(1.1);
    }

    /* Efectos de tabla */
    tbody tr {
      transition: all 0.3s ease;
    }

    tbody tr:hover {
      transform: translateX(5px);
    }

    /* Loading spinner */
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .spinner {
      animation: spin 1s linear infinite;
    }

    /* Estilo mejorado para "Ya Justificado" */
    .justified-badge {
      background: linear-gradient(135deg, #10b981 0%, #059669 50%, #047857 100%);
      box-shadow: 0 8px 16px rgba(16, 185, 129, 0.4), 0 0 40px rgba(16, 185, 129, 0.2);
      position: relative;
      overflow: hidden;
    }

    .justified-badge::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      transform: rotate(45deg);
      animation: shimmer 3s linear infinite;
    }

    .justified-badge-icon {
      background: rgba(255, 255, 255, 0.95);
      animation: pulse 2s ease-in-out infinite;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- React + ReactDOM (UMD) -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // Logo URL desde internet
    const LOGO_URL = "https://i.ibb.co/dwm03mTb/image-30.png";

    // Supabase
    const SUPABASE_URL = 'https://ebfknrtbfszjmnnhoxwe.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImViZmtucnRiZnN6am1ubmhveHdlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1NTg0NTgsImV4cCI6MjA3OTEzNDQ1OH0.eWgaIfmi7eFs7evpWfflm_MtXH8Ma9LA5s997hR1HGY';

    // Usuarios autorizados para inspección
    const AUTHORIZED_USERS = [
      { email: 'ricardobravo@uepdc.edu.ec', password: 'inspeccion2025', nombre: 'Ricardo Bravo', nombreCompleto: 'BRAVO RIVERA RICARDO ISAAC' },
      { email: 'angelamartinez@uepdc.edu.ec', password: 'inspeccion2025', nombre: 'Angela Martinez', nombreCompleto: 'MARTINEZ ZAMBRANO ANGELA VICTORIA' }
    ];

    // Función para obtener fecha y hora en Ecuador (UTC-5)
    const getEcuadorDateTime = () => {
      const now = new Date();
      const ecuadorOffset = -5 * 60 * 60 * 1000;
      const localOffset = now.getTimezoneOffset() * 60 * 1000;
      const ecuadorTime = new Date(now.getTime() + localOffset + ecuadorOffset);
      
      return {
        date: ecuadorTime,
        dateString: ecuadorTime.getFullYear() + '-' + 
                    String(ecuadorTime.getMonth() + 1).padStart(2, '0') + '-' + 
                    String(ecuadorTime.getDate()).padStart(2, '0'),
        timeString: String(ecuadorTime.getHours()).padStart(2, '0') + ':' + 
                    String(ecuadorTime.getMinutes()).padStart(2, '0'),
        displayDate: String(ecuadorTime.getDate()).padStart(2, '0') + '/' + 
                     String(ecuadorTime.getMonth() + 1).padStart(2, '0') + '/' + 
                     ecuadorTime.getFullYear()
      };
    };

    // Función para normalizar nombres
    const normalizeName = (name) => {
      if (!name) return '';
      return name
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/\s+/g, ' ')
        .trim();
    };

    // Función para verificar si dos nombres coinciden
    const namesMatch = (name1, name2) => {
      if (!name1 || !name2) return false;
      
      const normalized1 = normalizeName(name1);
      const normalized2 = normalizeName(name2);
      
      if (normalized1 === normalized2) return true;
      
      const words1 = normalized1.split(' ').filter(w => w.length > 2);
      const words2 = normalized2.split(' ').filter(w => w.length > 2);
      
      const matchingWords = words1.filter(w1 => words2.some(w2 => w1 === w2 || w1.includes(w2) || w2.includes(w1)));
      
      return matchingWords.length >= 2;
    };

    const supabaseRequest = async (endpoint, method = 'GET', body = null) => {
      const options = {
        method,
        headers: {
          'apikey': SUPABASE_ANON_KEY,
          'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
          'Content-Type': 'application/json',
          'Prefer': 'return=representation'
        }
      };
      if (body) options.body = JSON.stringify(body);

      const res = await fetch(`${SUPABASE_URL}/rest/v1/${endpoint}`, options);
      if (!res.ok) {
        let errText = 'Error en la petición';
        try { const j = await res.json(); errText = j.message || j.error || errText; } catch {}
        throw new Error(errText);
      }
      return res.json();
    };

    // FileUpload Component (SOLO para justificación)
    function FileUpload({ onFileSelect, selectedFile }) {
      const [isDragging, setIsDragging] = useState(false);
      const fileInputRef = useRef(null);

      const handleDragOver = (e) => {
        e.preventDefault();
        setIsDragging(true);
      };

      const handleDragLeave = () => {
        setIsDragging(false);
      };

      const handleDrop = (e) => {
        e.preventDefault();
        setIsDragging(false);
        const file = e.dataTransfer.files[0];
        if (file) onFileSelect(file);
      };

      const handleFileChange = (e) => {
        const file = e.target.files?.[0];
        if (file) onFileSelect(file);
      };

      useEffect(() => { if (window.lucide) window.lucide.replace(); }, [selectedFile]);

      return (
        <div className="animate-fadeIn">
          <label className="block text-sm font-semibold text-gray-700 mb-2">
            Adjuntar Evidencia (Opcional)
          </label>
          <div
            className={`file-upload-zone rounded-lg p-6 text-center cursor-pointer ${isDragging ? 'drag-over' : ''}`}
            onDragOver={handleDragOver}
            onDragLeave={handleDragLeave}
            onDrop={handleDrop}
            onClick={() => fileInputRef.current?.click()}
          >
            <input
              ref={fileInputRef}
              type="file"
              onChange={handleFileChange}
              className="hidden"
              accept="image/*,.pdf,.doc,.docx"
            />
            
            {selectedFile ? (
              <div className="flex items-center justify-center gap-3 animate-slideIn">
                <i data-lucide="file-check" style={{width:24,height:24}} className="text-institutional-blue"></i>
                <div className="text-left">
                  <p className="font-semibold text-institutional-blue">{selectedFile.name}</p>
                  <p className="text-sm text-gray-500">{(selectedFile.size / 1024).toFixed(2)} KB</p>
                </div>
                <button
                  onClick={(e) => { e.stopPropagation(); onFileSelect(null); }}
                  className="text-red-500 hover:text-red-700 p-1 hover-scale"
                >
                  <i data-lucide="x" style={{width:20,height:20}}></i>
                </button>
              </div>
            ) : (
              <div className="animate-bounce-slow">
                <i data-lucide="upload-cloud" style={{width:40,height:40}} className="mx-auto mb-3 text-institutional-blue"></i>
                <p className="text-institutional-blue font-semibold mb-1">
                  Arrastra un archivo aquí
                </p>
                <p className="text-sm text-gray-500">
                  o haz clic para seleccionar
                </p>
                <p className="text-xs text-gray-400 mt-2">
                  Formatos: PDF, DOC, DOCX, Imágenes
                </p>
              </div>
            )}
          </div>
        </div>
      );
    }

    // Login Component
    function Login({ onLogin }) {
      const [userType, setUserType] = useState('estudiante');
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [error, setError] = useState('');
      const [success, setSuccess] = useState('');
      
      const [nombreCompleto, setNombreCompleto] = useState('');
      const [cedula, setCedula] = useState('');
      const [curso, setCurso] = useState('');
      const [showRegister, setShowRegister] = useState(false);

      const handleLogin = async () => {
        setError('');
        setSuccess('');
        
        if (!email.trim() || !password.trim()) {
          setError('Por favor completa todos los campos');
          return;
        }

        if (userType === 'inspeccion') {
          const user = AUTHORIZED_USERS.find(u => u.email === email && u.password === password);
          if (user) {
            onLogin('inspeccion', email, { 
              nombre_completo: user.nombre, 
              email: user.email,
              nombreCompletoInspector: user.nombreCompleto 
            });
          } else {
            setError('Credenciales de inspección incorrectas');
          }
          return;
        }

        if (!email.endsWith('@est.uepdc.edu.ec')) {
          setError('El correo debe terminar en @est.uepdc.edu.ec');
          return;
        }

        try {
          const users = await supabaseRequest(`usuarios_estudiantes?email=eq.${encodeURIComponent(email)}&select=*`);
          
          if (!users || users.length === 0) {
            setError('Usuario no encontrado. Por favor regístrate primero.');
            return;
          }

          const user = users[0];
          if (user.password !== password) {
            setError('Contraseña incorrecta');
            return;
          }

          onLogin('estudiante', email, user);
        } catch (err) {
          setError('Error al iniciar sesión: ' + err.message);
        }
      };

      const handleRegister = async () => {
        setError('');
        setSuccess('');
        
        if (!email.trim() || !password.trim() || !nombreCompleto.trim() || !cedula.trim() || !curso.trim()) {
          setError('Por favor completa todos los campos obligatorios');
          return;
        }
        
        if (!email.endsWith('@est.uepdc.edu.ec')) {
          setError('El correo debe terminar en @est.uepdc.edu.ec');
          return;
        }

        try {
          const existing = await supabaseRequest(`usuarios_estudiantes?email=eq.${encodeURIComponent(email)}&select=*`);
          if (existing && existing.length > 0) {
            setError('Este correo ya está registrado');
            return;
          }

          const newUser = {
            email: email,
            password: password,
            nombre_completo: nombreCompleto,
            cedula: cedula,
            curso: curso 
          };

          await supabaseRequest('usuarios_estudiantes', 'POST', newUser);
          setSuccess('Registro exitoso. Ahora puedes iniciar sesión.');
          
          setEmail('');
          setPassword('');
          setNombreCompleto('');
          setCedula('');
          setCurso('');
          
          setTimeout(() => {
            setShowRegister(false);
            setSuccess('');
          }, 2000);
        } catch (err) {
          setError('Error al registrar: ' + err.message);
        }
      };

      useEffect(() => { if (window.lucide) window.lucide.replace(); }, [error, success, userType, showRegister]);

      return (
        <div className="min-h-screen bg-gradient-to-br from-blue-600 via-blue-500 to-blue-700 flex items-center justify-center p-4 animate-fadeIn">
          <div className="bg-white rounded-2xl shadow-2xl max-w-md w-full overflow-hidden border-4 border-institutional-yellow hover-glow animate-slideIn">
            <div className="bg-gradient-to-r from-institutional-blue to-institutional-blue-dark p-8 relative overflow-hidden">
              <div className="absolute inset-0 bg-gradient-to-br from-blue-600/20 to-transparent"></div>
              <div className="text-center text-white relative z-10">
                <img src={LOGO_URL} alt="UEPDC Logo" className="w-24 h-24 mx-auto mb-4 animate-pulse-slow drop-shadow-2xl" />
                <h1 className="text-3xl font-bold drop-shadow-2xl animate-fadeIn" style={{textShadow: '2px 2px 4px rgba(0,0,0,0.5)'}}>Sistema de Atrasos</h1>
                <p className="text-yellow-300 mt-2 font-bold text-lg drop-shadow-lg" style={{textShadow: '1px 1px 2px rgba(0,0,0,0.5)'}}>UEPDC</p>
              </div>
            </div>

            <div className="p-8">
              <div className="flex gap-2 mb-6">
                <button 
                  onClick={() => { setUserType('estudiante'); setShowRegister(false); }}
                  className={`flex-1 py-3 px-4 rounded-lg font-bold transition-all flex items-center justify-center gap-2 hover-scale ${
                    userType === 'estudiante' 
                      ? 'bg-gradient-to-r from-institutional-blue to-institutional-blue-dark text-white shadow-lg border-2 border-institutional-blue' 
                      : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                  }`}
                >
                  <i data-lucide="graduation-cap" style={{width:20,height:20}}></i>
                  Estudiante
                </button>
                <button 
                  onClick={() => { setUserType('inspeccion'); setShowRegister(false); }}
                  className={`flex-1 py-3 px-4 rounded-lg font-bold transition-all flex items-center justify-center gap-2 hover-scale ${
                    userType === 'inspeccion' 
                      ? 'bg-gradient-to-r from-institutional-yellow to-institutional-yellow-dark text-gray-800 shadow-lg border-2 border-institutional-yellow' 
                      : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                  }`}
                >
                  <i data-lucide="shield-check" style={{width:20,height:20}}></i>
                  Inspección
                </button>
              </div>

              {error && (
                <div className="mb-4 p-3 bg-red-50 border-2 border-red-300 rounded-lg text-red-700 text-sm flex items-center gap-2 animate-slideIn">
                  <i data-lucide="alert-circle" style={{width:18,height:18}}></i>
                  {error}
                </div>
              )}

              {success && (
                <div className="mb-4 p-3 bg-green-50 border-2 border-green-300 rounded-lg text-green-700 text-sm flex items-center gap-2 animate-slideIn">
                  <i data-lucide="check-circle" style={{width:18,height:18}}></i>
                  {success}
                </div>
              )}

              {userType === 'estudiante' && !showRegister ? (
                <div className="space-y-4 animate-fadeIn">
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Correo Estudiantil</label>
                    <input 
                      type="email" 
                      value={email} 
                      onChange={(e) => setEmail(e.target.value.toLowerCase())}
                      onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
                      placeholder="tu@est.uepdc.edu.ec"
                      className="w-full border-2 border-institutional-blue rounded-lg p-3 focus:ring-2 focus:ring-institutional-yellow focus:border-institutional-yellow transition-all"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Contraseña</label>
                    <input 
                      type="password" 
                      value={password} 
                      onChange={(e) => setPassword(e.target.value)}
                      onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
                      placeholder="••••••••"
                      className="w-full border-2 border-institutional-blue rounded-lg p-3 focus:ring-2 focus:ring-institutional-yellow focus:border-institutional-yellow transition-all"
                    />
                  </div>

                  <button 
                    onClick={handleLogin}
                    className="w-full bg-gradient-to-r from-institutional-blue to-institutional-blue-dark text-white py-3.5 rounded-lg font-bold hover:from-institutional-blue-dark hover:to-institutional-blue transition-all shadow-lg hover-scale flex items-center justify-center gap-2"
                  >
                    <i data-lucide="log-in" style={{width:20,height:20}}></i>
                    Iniciar Sesión
                  </button>

                  <button 
                    onClick={() => setShowRegister(true)}
                    className="w-full bg-white border-2 border-institutional-blue text-institutional-blue py-3.5 rounded-lg font-bold hover:bg-blue-50 transition-all hover-scale flex items-center justify-center gap-2"
                  >
                    <i data-lucide="user-plus" style={{width:20,height:20}}></i>
                    Registrarse
                  </button>
                </div>
              ) : userType === 'estudiante' && showRegister ? (
                <div className="space-y-4 animate-fadeIn">
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Nombre Completo *</label>
                    <input 
                      type="text" 
                      value={nombreCompleto} 
                      onChange={(e) => setNombreCompleto(e.target.value)}
                      placeholder="Nombre completo"
                      className="w-full border-2 border-institutional-blue rounded-lg p-3 focus:ring-2 focus:ring-institutional-yellow transition-all"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Correo Estudiantil *</label>
                    <input 
                      type="email" 
                      value={email} 
                      onChange={(e) => setEmail(e.target.value.toLowerCase())}
                      placeholder="tu@est.uepdc.edu.ec"
                      className="w-full border-2 border-institutional-blue rounded-lg p-3 focus:ring-2 focus:ring-institutional-yellow transition-all"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Cédula *</label>
                    <input 
                      type="text" 
                      value={cedula} 
                      onChange={(e) => setCedula(e.target.value)}
                      placeholder="0123456789"
                      className="w-full border-2 border-institutional-blue rounded-lg p-3 focus:ring-2 focus:ring-institutional-yellow transition-all"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Curso *</label>
                    <input 
                      type="text" 
                      value={curso} 
                      onChange={(e) => setCurso(e.target.value)}
                      placeholder="Ej: 3ro BGU A"
                      className="w-full border-2 border-institutional-blue rounded-lg p-3 focus:ring-2 focus:ring-institutional-yellow transition-all"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Contraseña *</label>
                    <input 
                      type="password" 
                      value={password} 
                      onChange={(e) => setPassword(e.target.value)}
                      placeholder="••••••••"
                      className="w-full border-2 border-institutional-blue rounded-lg p-3 focus:ring-2 focus:ring-institutional-yellow transition-all"
                    />
                  </div>

                  <button 
                    onClick={handleRegister}
                    className="w-full bg-gradient-to-r from-institutional-blue to-institutional-blue-dark text-white py-3.5 rounded-lg font-bold hover:from-institutional-blue-dark hover:to-institutional-blue transition-all shadow-lg hover-scale flex items-center justify-center gap-2"
                  >
                    <i data-lucide="user-check" style={{width:20,height:20}}></i>
                    Registrarse
                  </button>

                  <button 
                    onClick={() => setShowRegister(false)}
                    className="w-full bg-white border-2 border-gray-300 text-gray-700 py-3.5 rounded-lg font-bold hover:bg-gray-50 transition-all hover-scale flex items-center justify-center gap-2"
                  >
                    <i data-lucide="arrow-left" style={{width:20,height:20}}></i>
                    Volver a Iniciar Sesión
                  </button>
                </div>
              ) : (
                <div className="space-y-4 animate-fadeIn">
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Correo de Inspección</label>
                    <input 
                      type="email" 
                      value={email} 
                      onChange={(e) => setEmail(e.target.value.toLowerCase())}
                      onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
                      placeholder="inspector@uepdc.edu.ec"
                      className="w-full border-2 border-institutional-yellow rounded-lg p-3 focus:ring-2 focus:ring-institutional-blue transition-all"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Contraseña</label>
                    <input 
                      type="password" 
                      value={password} 
                      onChange={(e) => setPassword(e.target.value)}
                      onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
                      placeholder="••••••••"
                      className="w-full border-2 border-institutional-yellow rounded-lg p-3 focus:ring-2 focus:ring-institutional-blue transition-all"
                    />
                  </div>

                  <button 
                    onClick={handleLogin}
                    className="w-full bg-gradient-to-r from-institutional-yellow to-institutional-yellow-dark text-gray-800 py-3.5 rounded-lg font-bold hover:from-institutional-yellow-dark hover:to-institutional-yellow transition-all shadow-lg hover-scale flex items-center justify-center gap-2"
                  >
                    <i data-lucide="shield-check" style={{width:20,height:20}}></i>
                    Iniciar Sesión
                  </button>
                </div>
              )}
            </div>
          </div>
        </div>
      );
    }

    // QR Scanner component
    function QRScanner({ onScan, onClose }) {
      const [scanMode, setScanMode] = useState('camera');
      const [isScanning, setIsScanning] = useState(false);
      const [error, setError] = useState('');
      const videoRef = useRef(null);
      const canvasRef = useRef(null);
      const streamRef = useRef(null);
      const scanIntervalRef = useRef(null);

      const startCamera = async () => {
        try {
          setError('');
          const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }});
          if (videoRef.current) {
            videoRef.current.srcObject = stream;
            streamRef.current = stream;
            setIsScanning(true);
          }
        } catch (err) {
          setError('No se pudo acceder a la cámara. Por favor, da permisos de cámara.');
        }
      };

      const stopCamera = () => {
        if (streamRef.current) {
          streamRef.current.getTracks().forEach(t => t.stop());
          streamRef.current = null;
        }
        if (scanIntervalRef.current) {
          clearInterval(scanIntervalRef.current);
          scanIntervalRef.current = null;
        }
        setIsScanning(false);
      };

      const scanQRCode = () => {
        if (!videoRef.current || !canvasRef.current) return;
        
        const video = videoRef.current;
        const canvas = canvasRef.current;
        const ctx = canvas.getContext('2d');

        if (video.readyState === video.HAVE_ENOUGH_DATA) {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const code = window.jsQR ? window.jsQR(imageData.data, imageData.width, imageData.height) : null;

          if (code) {
            stopCamera();
            const qrData = code.data;
            const idMatch = qrData.match(/ID:(\d+)/i);
            const studentId = idMatch ? idMatch[1] : qrData;
            onScan(studentId);
          }
        }
      };

      const handleScanClick = () => {
        if (scanIntervalRef.current) {
          clearInterval(scanIntervalRef.current);
        }
        scanIntervalRef.current = setInterval(scanQRCode, 100);
      };

      useEffect(() => {
        if (scanMode === 'camera') {
          startCamera();
        } else {
          stopCamera();
        }
        return () => stopCamera();
      }, [scanMode]);

      const handleFileChange = (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (evt) => {
          const img = new Image();
          img.onload = () => {
            const canvas = canvasRef.current;
            const ctx = canvas.getContext('2d');
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const code = window.jsQR ? window.jsQR(imageData.data, imageData.width, imageData.height) : null;
            if (code) {
              const qrData = code.data;
              const idMatch = qrData.match(/ID:(\d+)/i);
              const studentId = idMatch ? idMatch[1] : qrData;
              onScan(studentId);
            } else {
              setError('No se detectó ningún código QR en la imagen');
            }
          };
          img.src = evt.target.result;
        };
        reader.readAsDataURL(file);
      };

      useEffect(() => {
        if (window.lucide) window.lucide.replace();
      }, [scanMode, isScanning, error]);

      return (
        <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4 animate-fadeIn">
          <div className="bg-white rounded-2xl shadow-2xl max-w-md w-full overflow-hidden relative border-4 border-institutional-yellow animate-slideIn">
            <button 
              onClick={() => { stopCamera(); onClose(); }} 
              className="absolute top-4 right-4 bg-red-500 hover:bg-red-600 text-white rounded-full p-2 transition-all z-10 hover-scale shadow-lg flex items-center justify-center"
              style={{width: '40px', height: '40px'}}
            >
              <i data-lucide="x" style={{width:24,height:24}}></i>
            </button>
            <div className="bg-institutional-blue p-4">
              <div className="flex items-center gap-2 text-white">
                <i data-lucide="qr-code" style={{width:24,height:24}}></i>
                <h2 className="text-xl font-bold">Escanear Código QR</h2>
              </div>
            </div>

            <div className="p-6">
              <div className="flex gap-2 mb-4">
                <button onClick={() => setScanMode('camera')}
                  className={`flex-1 py-2 px-4 rounded-lg font-semibold transition-all hover-scale ${scanMode === 'camera' ? 'bg-institutional-blue text-white' : 'bg-gray-200 text-gray-700'}`}>
                  <i data-lucide="camera" style={{width:16,height:16}} className="inline mr-2"></i> Cámara
                </button>
                <button onClick={() => setScanMode('file')}
                  className={`flex-1 py-2 px-4 rounded-lg font-semibold transition-all hover-scale ${scanMode === 'file' ? 'bg-institutional-blue text-white' : 'bg-gray-200 text-gray-700'}`}>
                  <i data-lucide="file-text" style={{width:16,height:16}} className="inline mr-2"></i> Archivo
                </button>
              </div>

              {error && <div className="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm animate-slideIn">{error}</div>}

              <div className="bg-gray-100 rounded-lg overflow-hidden border-4 border-institutional-yellow">
                {scanMode === 'camera' ? (
                  <div className="relative aspect-square">
                    <video ref={videoRef} autoPlay playsInline muted className="w-full h-full object-cover" />
                    {isScanning && <div className="absolute inset-0 flex items-center justify-center"><div className="border-4 border-institutional-yellow w-48 h-48 rounded-lg animate-pulse-slow"></div></div>}
                  </div>
                ) : (
                  <div className="aspect-square flex items-center justify-center p-8">
                    <div className="text-center">
                      <i data-lucide="file-text" style={{width:48,height:48}} className="mx-auto text-institutional-blue mb-4 animate-bounce-slow"></i>
                      <p className="text-gray-600 mb-4">Selecciona una imagen con el código QR</p>
                      <label className="bg-institutional-yellow text-gray-800 py-2 px-4 rounded-lg hover:bg-institutional-yellow-dark font-semibold cursor-pointer inline-block hover-scale">
                        Seleccionar Imagen
                        <input type="file" accept="image/*" onChange={handleFileChange} className="hidden" />
                      </label>
                    </div>
                  </div>
                )}
              </div>

              <canvas ref={canvasRef} className="hidden"></canvas>

              {scanMode === 'camera' && isScanning && (
                <button 
                  onClick={handleScanClick}
                  className="w-full mt-4 bg-institutional-yellow text-gray-800 py-3 rounded-lg font-semibold hover:bg-institutional-yellow-dark transition-all shadow-lg flex items-center justify-center gap-2 hover-scale"
                >
                  <i data-lucide="scan" style={{width:20,height:20}}></i>
                  Leer Código QR
                </button>
              )}
            </div>
          </div>
        </div>
      );
    }

    // ManualInput component
    function ManualInput({ onSubmit, onClose }) {
      const [code, setCode] = useState('');
      
      useEffect(() => {
        if (window.lucide) window.lucide.replace();
      }, []);

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 animate-fadeIn">
          <div className="bg-white rounded-2xl shadow-2xl max-w-md w-full overflow-hidden border-4 border-institutional-yellow animate-slideIn">
            <div className="bg-institutional-blue p-4 flex items-center justify-between">
              <h2 className="text-xl font-bold text-white">Ingreso Manual</h2>
              <button onClick={onClose} className="text-white hover:bg-institutional-blue-dark rounded-lg p-2 hover-scale"><i data-lucide="x" style={{width:24,height:24}}></i></button>
            </div>
            <div className="p-6">
              <label className="block text-sm font-semibold text-gray-700 mb-2">Buscar por nombre, curso o ID</label>
              <input type="text" value={code} onChange={(e)=>setCode(e.target.value)} placeholder="Ej: Juan Pérez, 1A, o ID del estudiante"
                className="w-full border-2 border-institutional-blue rounded-lg p-3 focus:ring-2 focus:ring-institutional-yellow focus:border-institutional-yellow mb-4 transition-all"
                onKeyPress={(e)=> e.key==='Enter' && onSubmit(code.trim())}
              />
              <div className="flex gap-3">
                <button onClick={onClose} className="flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-300 hover-scale">Cancelar</button>
                <button onClick={()=>onSubmit(code.trim())} className="flex-1 bg-institutional-blue text-white py-3 rounded-lg font-semibold hover:bg-institutional-blue-dark hover-scale">Buscar</button>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // StudentModal component - SIN motivo ni archivo
    function StudentModal({ student, onConfirm, onClose, isSubmitting, userData }) {
      const recordedBy = userData?.nombreCompletoInspector || '';
      const ecuadorDateTime = getEcuadorDateTime();

      const handleConfirm = () => {
        if (recordedBy.trim()) {
          onConfirm(recordedBy);
        } else {
          alert('Error: No se pudo identificar al inspector');
        }
      };

      useEffect(()=> { if (window.lucide) window.lucide.replace(); }, [student, isSubmitting]);

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 animate-fadeIn">
          <div className="bg-white rounded-2xl shadow-2xl max-w-lg w-full overflow-hidden border-4 border-institutional-yellow max-h-[90vh] overflow-y-auto animate-slideIn">
            <div className="bg-institutional-yellow p-6 relative">
              <button onClick={onClose} className="absolute top-4 right-4 text-gray-700 hover:bg-institutional-yellow-dark rounded-lg p-2 hover-scale" disabled={isSubmitting}><i data-lucide="x" style={{width:24,height:24}}></i></button>
              <div className="flex items-center gap-3 text-gray-800">
                <div className="bg-white rounded-full p-3 animate-pulse-slow"><i data-lucide="user" style={{width:32,height:32}} className="text-institutional-blue"></i></div>
                <div>
                  <h2 className="text-2xl font-bold">Registro de Atraso</h2>
                  <p className="text-sm opacity-80">Confirmar información del estudiante</p>
                </div>
              </div>
            </div>

            <div className="p-6 space-y-4">
              <div className="bg-blue-50 border-l-4 border-institutional-blue p-4 rounded-r-lg animate-slideIn">
                <div className="flex items-center gap-2 mb-2">
                  <i data-lucide="user" style={{width:18,height:18}} className="text-institutional-blue"></i>
                  <span className="font-semibold text-gray-700">Nombre Completo</span>
                </div>
                <p className="text-lg font-bold text-gray-900">{student['Nombre completo estudiante']}</p>
              </div>

              <div className="grid grid-cols-3 gap-4">
                <div className="bg-gray-50 p-4 rounded-lg border-2 border-institutional-blue hover-glow transition-all">
                  <span className="text-sm text-gray-600">Curso</span>
                  <p className="font-semibold text-gray-900">{student.Curso}</p>
                </div>
                <div className="bg-gray-50 p-4 rounded-lg border-2 border-institutional-blue hover-glow transition-all">
                  <span className="text-sm text-gray-600">Fecha</span>
                  <p className="font-semibold text-gray-900">{ecuadorDateTime.displayDate}</p>
                </div>
                <div className="bg-gray-50 p-4 rounded-lg border-2 border-institutional-blue hover-glow transition-all">
                  <span className="text-sm text-gray-600">Hora</span>
                  <p className="font-semibold text-gray-900">{ecuadorDateTime.timeString}</p>
                </div>
              </div>

              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-2">Registrado por</label>
                <div className="w-full border-2 border-institutional-yellow bg-yellow-50 rounded-lg p-3 flex items-center gap-2">
                  <i data-lucide="shield-check" style={{width:20,height:20}} className="text-gray-700"></i>
                  <span className="font-semibold text-gray-800">{recordedBy}</span>
                </div>
              </div>
            </div>

            <div className="bg-gray-50 p-6 flex gap-3">
              <button onClick={onClose} disabled={isSubmitting} className="flex-1 bg-white border-2 border-gray-300 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-100 flex items-center justify-center gap-2 hover-scale">
                <i data-lucide="x" style={{width:20,height:20}}></i> Cerrar
              </button>
              <button onClick={handleConfirm} disabled={isSubmitting} className="flex-1 bg-institutional-blue text-white py-3 rounded-lg font-semibold hover:bg-institutional-blue-dark flex items-center justify-center gap-2 hover-scale">
                <i data-lucide="check-circle" style={{width:20,height:20}}></i> {isSubmitting ? 'Guardando...' : 'Confirmar Atraso'}
              </button>
            </div>
          </div>
        </div>
      );
    }

    // JustificationModal component - CON archivo
    function JustificationModal({ record, onClose, onSubmit, isSubmitting }) {
      const [justification, setJustification] = useState(record.motivo_atraso || '');
      const [selectedFile, setSelectedFile] = useState(null);

      const handleSubmit = async () => {
        if (!justification.trim()) {
          alert('Por favor ingresa el motivo de justificación');
          return;
        }
        onSubmit(justification, selectedFile);
      };

      useEffect(() => { if (window.lucide) window.lucide.replace(); }, [selectedFile]);

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 animate-fadeIn">
          <div className="bg-white rounded-2xl shadow-2xl max-w-lg w-full overflow-hidden max-h-[90vh] overflow-y-auto border-4 border-institutional-yellow animate-slideIn">
            <div className="bg-institutional-blue p-6">
              <div className="flex items-center justify-between">
                <h2 className="text-xl font-bold text-white">Justificar Atraso</h2>
                <button onClick={onClose} disabled={isSubmitting} className="text-white hover:bg-institutional-blue-dark rounded-lg p-2 hover-scale">
                  <i data-lucide="x" style={{width:24,height:24}}></i>
                </button>
              </div>
            </div>

            <div className="p-6 space-y-4">
              <div className="bg-blue-50 border-l-4 border-institutional-blue p-4 rounded-r-lg animate-slideIn">
                <div className="flex items-center gap-2 mb-2">
                  <i data-lucide="user" style={{width:18,height:18}} className="text-institutional-blue"></i>
                  <span className="font-semibold text-gray-700">Estudiante</span>
                </div>
                <p className="text-lg font-bold text-gray-900">{record['Nombre completo estudiante']}</p>
                <div className="mt-2 text-sm text-gray-600">
                  <p><strong>Curso:</strong> {record.Curso}</p>
                  <p><strong>Fecha:</strong> {new Date(record.fecha_atraso + 'T00:00:00').toLocaleDateString('es-ES')}</p>
                  <p><strong>Hora:</strong> {record.hora_llegada}</p>
                </div>
              </div>

              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-2">Motivo de Justificación *</label>
                <textarea 
                  value={justification} 
                  onChange={(e) => setJustification(e.target.value)}
                  placeholder="Ingrese el motivo de la justificación..."
                  className="w-full border-2 border-institutional-blue rounded-lg p-3 focus:ring-2 focus:ring-institutional-yellow resize-none transition-all"
                  rows={4}
                  disabled={isSubmitting}
                />
              </div>

              <FileUpload onFileSelect={setSelectedFile} selectedFile={selectedFile} />
            </div>

            <div className="bg-gray-50 p-6 flex gap-3">
              <button 
                onClick={onClose} 
                disabled={isSubmitting}
                className="flex-1 bg-white border-2 border-gray-300 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-100 hover-scale"
              >
                Cancelar
              </button>
              <button 
                onClick={handleSubmit}
                disabled={isSubmitting || !justification.trim()}
                className="flex-1 bg-institutional-blue text-white py-3 rounded-lg font-semibold hover:bg-institutional-blue-dark disabled:bg-gray-400 flex items-center justify-center gap-2 hover-scale"
              >
                {isSubmitting ? (
                  <>
                    <div className="spinner rounded-full h-5 w-5 border-b-2 border-white"></div>
                    Guardando...
                  </>
                ) : (
                  <>
                    <i data-lucide="check-circle" style={{width:20,height:20}}></i>
                    Justificar
                  </>
                )}
              </button>
            </div>
          </div>
        </div>
      );
    }

    // AttendanceHistory component
    function AttendanceHistory({ records, loading, onRefresh, userRole, userData, onJustify }) {
      const [searchTerm, setSearchTerm] = useState('');
      const [dateFilter, setDateFilter] = useState('');
      const [statusFilter, setStatusFilter] = useState('all');

      const normalizeDate = (dateString) => {
        if (!dateString) return '';
        if (/^\d{4}-\d{2}-\d{2}$/.test(dateString)) return dateString;
        return dateString.split('T')[0];
      };

      // Función helper para determinar si un registro está justificado
      const isJustified = (record) => {
        // Un registro está justificado si tiene "[Archivo adjunto:" en el motivo
        return record.motivo_atraso && record.motivo_atraso.includes('[Archivo adjunto:');
      };

      const filteredRecords = records.filter(record => {
        const matchesSearch = !searchTerm || 
          (record['Nombre completo estudiante']?.toLowerCase().includes(searchTerm.toLowerCase()) || 
           record.Curso?.toLowerCase().includes(searchTerm.toLowerCase()));
        
        let matchesDate = true;
        if (dateFilter) {
          const recordDateStr = normalizeDate(record.fecha_atraso);
          matchesDate = recordDateStr === dateFilter;
        }
        
        // Actualizar la lógica de filtro por estado
        let matchesStatus = true;
        if (statusFilter === 'confirmado') {
          matchesStatus = record.estado === 'confirmado' && !isJustified(record);
        } else if (statusFilter === 'justificado') {
          matchesStatus = isJustified(record);
        }
        // Si statusFilter === 'all', matchesStatus permanece true
        
        const hasValidStatus = record.estado === 'confirmado';
        
        if (userRole === 'estudiante' && userData) {
          const studentNameInRecord = record['Nombre completo estudiante'];
          const loggedInStudentName = userData.nombre_completo;
          const matchesStudent = namesMatch(studentNameInRecord, loggedInStudentName);
          
          return matchesSearch && matchesDate && matchesStatus && hasValidStatus && matchesStudent;
        }
        
        return matchesSearch && matchesDate && matchesStatus && hasValidStatus;
      });

      useEffect(()=> { if (window.lucide) window.lucide.replace(); }, [records, searchTerm, dateFilter, statusFilter, loading]);

      const clearFilters = () => {
        setSearchTerm('');
        setDateFilter('');
        setStatusFilter('all');
      };

      return (
        <div className="bg-white rounded-2xl shadow-lg overflow-hidden border-4 border-institutional-yellow animate-fadeIn">
          <div className="bg-institutional-yellow p-6">
            <div className="flex items-center justify-between flex-wrap gap-4">
              <div className="flex items-center gap-3 text-gray-800">
                <i data-lucide="history" style={{width:28,height:28}} className="animate-bounce-slow"></i>
                <h2 className="text-2xl font-bold">Historial de Atrasos</h2>
              </div>
              <button onClick={onRefresh} className="bg-gradient-to-r from-white to-gray-50 text-institutional-blue px-5 py-2.5 rounded-lg font-bold hover:from-gray-50 hover:to-white flex items-center gap-2 border-2 border-institutional-blue hover-scale shadow-md">
                <i data-lucide="refresh-cw" style={{width:20,height:20}}></i> Actualizar
              </button>
            </div>
          </div>

          <div className="p-6 border-b-2 border-institutional-yellow bg-gray-50">
            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
              <input 
                type="text" 
                value={searchTerm} 
                onChange={(e)=>setSearchTerm(e.target.value)} 
                placeholder="Buscar por nombre o curso" 
                className="border-2 border-institutional-blue rounded-lg p-2 focus:ring-2 focus:ring-institutional-yellow transition-all" 
              />
              <input 
                type="date" 
                value={dateFilter} 
                onChange={(e)=>setDateFilter(e.target.value)} 
                className="border-2 border-institutional-blue rounded-lg p-2 focus:ring-2 focus:ring-institutional-yellow transition-all" 
              />
              <select 
                value={statusFilter} 
                onChange={(e)=>setStatusFilter(e.target.value)} 
                className="border-2 border-institutional-blue rounded-lg p-2 focus:ring-2 focus:ring-institutional-yellow transition-all"
              >
                <option value="all">Todos los estados</option>
                <option value="confirmado">Confirmados</option>
                <option value="justificado">Justificados</option>
              </select>
              <button 
                onClick={clearFilters}
                className="bg-gradient-to-r from-gray-200 to-gray-300 text-gray-800 px-4 py-2 rounded-lg font-bold hover:from-gray-300 hover:to-gray-200 flex items-center justify-center gap-2 hover-scale shadow-sm border-2 border-gray-400"
              >
                <i data-lucide="filter-x" style={{width:20,height:20}}></i> Limpiar
              </button>
            </div>
          </div>

          <div className="p-6">
            {loading ? (
              <div className="text-center py-8">
                <div className="spinner rounded-full h-12 w-12 border-b-4 border-institutional-blue mx-auto"></div>
                <p className="mt-4 text-gray-600">Cargando historial...</p>
              </div>
            ) : (
              <>
                <div className="text-sm text-gray-600 mb-4 flex items-center gap-2 animate-slideIn">
                  <i data-lucide="database" style={{width:16,height:16}} className="text-institutional-blue"></i>
                  Mostrando {filteredRecords.length} de {records.filter(r => r.estado === 'confirmado').length} registros
                </div>
                <div className="overflow-x-auto">
                  <table className="w-full">
                    <thead className="bg-institutional-blue text-white"><tr>
                      <th className="text-left p-3 text-sm font-semibold">Fecha</th>
                      <th className="text-left p-3 text-sm font-semibold">Estudiante</th>
                      <th className="text-left p-3 text-sm font-semibold">Curso</th>
                      <th className="text-left p-3 text-sm font-semibold">Hora</th>
                      <th className="text-left p-3 text-sm font-semibold">Motivo</th>
                      {userRole === 'inspeccion' && <th className="text-left p-3 text-sm font-semibold">Registrado por</th>}
                      <th className="text-left p-3 text-sm font-semibold">Estado</th>
                      {userRole === 'inspeccion' && <th className="text-left p-3 text-sm font-semibold">Acciones</th>}
                    </tr></thead>
                    <tbody>
                      {filteredRecords.length === 0 ? (
                        <tr><td colSpan={userRole === 'inspeccion' ? '8' : '6'} className="text-center py-8 text-gray-500">
                          <i data-lucide="search-x" style={{width:48,height:48}} className="mx-auto mb-2 text-gray-300 animate-bounce-slow"></i>
                          <p>No se encontraron registros de atrasos</p>
                        </td></tr>
                      ) : (
                        filteredRecords.map((record, index) => (
                          <tr key={record.N || index} className="border-b-2 border-gray-100 hover:bg-yellow-50 transition-all">
                            <td className="p-3 text-sm">{new Date(record.fecha_atraso + 'T00:00:00').toLocaleDateString('es-ES')}</td>
                            <td className="p-3 text-sm font-medium">{record['Nombre completo estudiante']}</td>
                            <td className="p-3 text-sm">{record.Curso}</td>
                            <td className="p-3 text-sm">
                              <span className="flex items-center gap-1">
                                <i data-lucide="clock" style={{width:14,height:14}} className="text-institutional-blue"></i>
                                {record.hora_llegada || 'N/A'}
                              </span>
                            </td>
                            <td className="p-3 text-sm text-gray-600">{record.motivo_atraso || 'Sin especificar'}</td>
                            {userRole === 'inspeccion' && <td className="p-3 text-sm text-gray-600">{record.registrado_por || 'N/A'}</td>}
                            <td className="p-3">
                              {isJustified(record) ? (
                                <span className="inline-flex items-center gap-1 bg-institutional-blue text-white px-3 py-1 rounded-full text-xs font-semibold">
                                  <i data-lucide="file-check" style={{width:14,height:14}}></i> Justificado
                                </span>
                              ) : record.estado === 'confirmado' ? (
                                <span className="inline-flex items-center gap-1 bg-institutional-yellow text-gray-800 px-3 py-1 rounded-full text-xs font-semibold border-2 border-institutional-blue">
                                  <i data-lucide="alert-circle" style={{width:14,height:14}}></i> Confirmado
                                </span>
                              ) : (
                                <span className="inline-flex items-center gap-1 bg-gray-200 text-gray-700 px-3 py-1 rounded-full text-xs font-semibold">
                                  <i data-lucide="clock" style={{width:14,height:14}}></i> Pendiente
                                </span>
                              )}
                            </td>
                            {userRole === 'inspeccion' && (
                              <td className="p-3">
                                {!isJustified(record) ? (
                                  <button
                                    onClick={() => onJustify(record)}
                                    className="bg-institutional-blue text-white px-3 py-1 rounded-lg text-xs font-semibold hover:bg-institutional-blue-dark flex items-center gap-1 hover-scale"
                                  >
                                    <i data-lucide="file-edit" style={{width:12,height:12}}></i>
                                    Justificar
                                  </button>
                                ) : (
                                  <div className="justified-badge inline-flex items-center gap-2 text-white px-4 py-2 rounded-xl text-xs font-black shadow-lg hover-scale animate-fadeIn">
                                    <div className="justified-badge-icon rounded-full p-1">
                                      <i data-lucide="badge-check" style={{width:16,height:16}} className="text-emerald-600"></i>
                                    </div>
                                    <span className="tracking-wide" style={{textShadow: '0 1px 2px rgba(0,0,0,0.3)'}}>JUSTIFICADO</span>
                                  </div>
                                )}
                              </td>
                            )}
                          </tr>
                        ))
                      )}
                    </tbody>
                  </table>
                </div>
              </>
            )}
          </div>
        </div>
      );
    }

    // Main App
    function App(){
      const [userRole, setUserRole] = useState(null);
      const [userEmail, setUserEmail] = useState('');
      const [userData, setUserData] = useState(null);
      const [view, setView] = useState('scanner');
      const [showScanner, setShowScanner] = useState(false);
      const [showManualInput, setShowManualInput] = useState(false);
      const [selectedStudent, setSelectedStudent] = useState(null);
      const [isSubmitting, setIsSubmitting] = useState(false);
      const [notification, setNotification] = useState(null);
      const [records, setRecords] = useState([]);
      const [loading, setLoading] = useState(false);
      const [justificationRecord, setJustificationRecord] = useState(null);

      const handleLogin = (role, email, user) => {
        setUserRole(role);
        setUserEmail(email);
        setUserData(user);
        if (role === 'estudiante') {
          setView('history');
        }
      };

      const handleLogout = () => {
        setUserRole(null);
        setUserEmail('');
        setUserData(null);
        setView('scanner');
      };

      useEffect(()=> {
        if (view === 'history') loadAttendanceRecords();
      }, [view]);

      useEffect(()=> {
        if (window.lucide) window.lucide.replace();
      }, [view, showScanner, showManualInput, selectedStudent, notification, records, userRole, justificationRecord]);

      const showNotification = (type, message) => {
        setNotification({type, message});
        setTimeout(()=> setNotification(null), 4000);
      };

      const handleJustification = (record) => {
        setJustificationRecord(record);
      };

      // CORREGIDO: submitJustification - Solo actualiza motivo_atraso (no cambia estado)
      const submitJustification = async (justification, file) => {
        setIsSubmitting(true);
        try {
          let fileInfo = null;
          if (file) {
            fileInfo = {
              name: file.name,
              size: file.size,
              type: file.type
            };
          }

          const motivoTexto = justification + (fileInfo ? ` [Archivo adjunto: ${fileInfo.name}]` : '');

          // Solo actualizar el motivo (el constraint no permite cambiar estado)
          const updateData = {
            motivo_atraso: motivoTexto
          };
          
          await supabaseRequest(`atrasos?N=eq.${justificationRecord.N}`, 'PATCH', updateData);
          
          showNotification('success', 'Justificación guardada correctamente');
          setJustificationRecord(null);
          await loadAttendanceRecords();
        } catch (err) {
          console.error('Error al justificar:', err);
          showNotification('error', 'Error al guardar la justificación: ' + err.message);
        } finally {
          setIsSubmitting(false);
        }
      };

      const findStudent = async (searchTerm) => {
        try {
          setIsSubmitting(true);
          let students = [];

          if (!isNaN(searchTerm)) {
            const byId = await supabaseRequest(`atrasos?N=eq.${searchTerm}&select=*&limit=1`);
            if (byId && byId.length > 0) students = [byId[0]];
          }

          if (students.length === 0) {
            const byName = await supabaseRequest(`atrasos?or=(Nombre%20completo%20estudiante.ilike.*${encodeURIComponent(searchTerm)}*,Curso.ilike.*${encodeURIComponent(searchTerm)}*)&select=*&limit=1`);
            if (byName && byName.length > 0) students = [byName[0]];
          }

          if (!students || students.length === 0) {
            showNotification('error','Estudiante no encontrado');
            setIsSubmitting(false);
            setShowScanner(false);
            setShowManualInput(false);
            return;
          }

          const student = students[0];
          
          const ecuadorDateTime = getEcuadorDateTime();
          const today = ecuadorDateTime.dateString;
          
          const todayQuery = `Nombre%20completo%20estudiante=eq.${encodeURIComponent(student['Nombre completo estudiante'])}&fecha_atraso=eq.${today}&estado=in.(confirmado,justificado)`;
          const existingRecords = await supabaseRequest(`atrasos?${todayQuery}`);

          if (existingRecords && existingRecords.length > 0) {
            showNotification('error','Este estudiante ya tiene un registro de atraso hoy');
            setIsSubmitting(false);
            setShowScanner(false);
            setShowManualInput(false);
            return;
          }

          setSelectedStudent(student);
          setShowScanner(false);
          setShowManualInput(false);
          setIsSubmitting(false);
        } catch (err) {
          console.error('Error al buscar estudiante:', err);
          showNotification('error','Error al buscar estudiante: ' + err.message);
          setIsSubmitting(false);
          setShowScanner(false);
          setShowManualInput(false);
        }
      };

      // CORREGIDO: handleConfirmAttendance - SIN motivo ni archivo
      const handleConfirmAttendance = async (recordedBy) => {
        setIsSubmitting(true);
        try {
          const ecuadorDateTime = getEcuadorDateTime();

          const newRecord = {
            'Nombre completo estudiante': selectedStudent['Nombre completo estudiante'],
            Curso: selectedStudent.Curso,
            'Email estudiante': selectedStudent['Email estudiante'] || null,
            fecha_atraso: ecuadorDateTime.dateString,
            hora_llegada: ecuadorDateTime.timeString,
            registrado_por: recordedBy,
            estado: 'confirmado'
          };
          
          await supabaseRequest(`atrasos`, 'POST', newRecord);
          showNotification('success', `Atraso confirmado para ${selectedStudent['Nombre completo estudiante']}`);
          setSelectedStudent(null);
          await loadAttendanceRecords();
        } catch (err) {
          console.error('Error al guardar:', err);
          showNotification('error','Error al registrar el atraso: ' + err.message);
        } finally {
          setIsSubmitting(false);
        }
      };

      const loadAttendanceRecords = async () => {
        setLoading(true);
        try {
          const allRecords = await supabaseRequest('atrasos?order=fecha_atraso.desc,hora_llegada.desc&estado=eq.confirmado&limit=1000');
          setRecords(allRecords || []);
        } catch (err) {
          console.error('Error al cargar registros:', err);
          showNotification('error','Error al cargar el historial: ' + err.message);
          setRecords([]);
        } finally {
          setLoading(false);
        }
      };

      if (!userRole) {
        return <Login onLogin={handleLogin} />;
      }

      return (
        <div className="min-h-screen bg-gradient-to-br from-blue-50 via-white to-yellow-50">
          <header className="bg-institutional-blue shadow-lg border-b-4 border-institutional-yellow">
            <div className="container mx-auto px-4 py-6">
              <div className="flex justify-between items-center flex-wrap gap-4">
                <div className="flex items-center gap-4">
                  <img src={LOGO_URL} alt="UEPDC Logo" className="logo-container" />
                  <div>
                    <h1 className="text-2xl md:text-3xl font-bold text-white drop-shadow-lg flex items-center gap-3">
                      Sistema de Atrasos
                    </h1>
                    <p className="text-yellow-200 mt-1 font-semibold text-sm">
                      {userRole === 'inspeccion' ? '🛡️ Panel de Inspección' : '👨‍🎓 Panel de Estudiantes'} - {userData?.nombreCompletoInspector || userData?.nombre_completo || userEmail}
                    </p>
                  </div>
                </div>
                <button 
                  onClick={handleLogout}
                  className="bg-gradient-to-r from-institutional-yellow to-institutional-yellow-dark text-gray-800 px-5 py-2.5 rounded-lg font-bold hover:from-institutional-yellow-dark hover:to-institutional-yellow flex items-center gap-2 border-2 border-white hover-scale shadow-lg transition-all"
                >
                  <i data-lucide="log-out" style={{width:20,height:20}}></i> 
                  <span>Cerrar Sesión</span>
                </button>
              </div>
            </div>
          </header>

          {notification && (
            <div className="fixed top-4 right-4 z-50 animate-bounce">
              <div className={`rounded-lg shadow-2xl p-4 flex items-center gap-3 max-w-md border-4 ${
                notification.type === 'success' 
                  ? 'bg-institutional-blue text-white border-institutional-yellow' 
                  : 'bg-red-500 text-white border-red-700'
              }`}>
                <i data-lucide={notification.type === 'success' ? 'check-circle' : 'alert-circle'} style={{width:24,height:24}}></i>
                <span className="font-semibold">{notification.message}</span>
              </div>
            </div>
          )}

          {userRole === 'inspeccion' && (
            <nav className="bg-white shadow-md sticky top-0 z-40 border-b-4 border-institutional-yellow">
              <div className="container mx-auto px-4">
                <div className="flex justify-center gap-3 py-4">
                  <button onClick={()=>setView('scanner')} className={`flex items-center gap-2 px-6 py-3 rounded-lg font-bold transition-all hover-scale ${view==='scanner' ? 'bg-gradient-to-r from-institutional-yellow to-institutional-yellow-dark text-gray-800 shadow-lg border-2 border-institutional-blue' : 'bg-gray-100 text-gray-600 hover:bg-gray-200 border-2 border-gray-300'}`}>
                    <i data-lucide="user-plus" style={{width:20,height:20}}></i> Registrar Atraso
                  </button>
                  <button onClick={()=>setView('history')} className={`flex items-center gap-2 px-6 py-3 rounded-lg font-bold transition-all hover-scale ${view==='history' ? 'bg-gradient-to-r from-institutional-yellow to-institutional-yellow-dark text-gray-800 shadow-lg border-2 border-institutional-blue' : 'bg-gray-100 text-gray-600 hover:bg-gray-200 border-2 border-gray-300'}`}>
                    <i data-lucide="list-checks" style={{width:20,height:20}}></i> Historial
                  </button>
                </div>
              </div>
            </nav>
          )}

          <main className="container mx-auto px-4 py-8">
            {view === 'scanner' && userRole === 'inspeccion' ? (
              <div className="max-w-2xl mx-auto animate-fadeIn">
                <div className="bg-white rounded-2xl shadow-lg p-8 md:p-12 border-4 border-institutional-yellow hover-glow">
                  <div className="text-center mb-8">
                    <img src={LOGO_URL} alt="UEPDC Logo" className="w-24 h-24 mx-auto mb-4 animate-pulse-slow" />
                    <h2 className="text-2xl md:text-3xl font-bold text-gray-800 mb-3">Registrar Atraso Estudiantil</h2>
                    <p className="text-gray-600">Selecciona un método para identificar al estudiante</p>
                  </div>

                  <div className="space-y-4">
                    <button onClick={()=>setShowScanner(true)} className="w-full bg-institutional-blue text-white py-4 px-6 rounded-xl font-semibold hover:bg-institutional-blue-dark transition-all shadow-lg flex items-center justify-center gap-3 text-lg border-2 border-institutional-yellow hover-scale">
                      <i data-lucide="camera" style={{width:24,height:24}}></i> Escanear Código QR
                    </button>

                    <button onClick={()=>setShowManualInput(true)} className="w-full bg-institutional-yellow text-gray-800 py-4 px-6 rounded-xl font-semibold hover:bg-institutional-yellow-dark transition-all shadow-lg flex items-center justify-center gap-3 text-lg border-2 border-institutional-blue hover-scale">
                      <i data-lucide="file-text" style={{width:24,height:24}}></i> Ingreso Manual
                    </button>
                  </div>

                  <div className="mt-8 p-4 bg-blue-50 rounded-lg border-2 border-institutional-blue">
                    <p className="text-sm text-institutional-blue text-center flex items-center justify-center gap-2">
                      <i data-lucide="info" style={{width:18,height:18}}></i>
                      <strong>Nota:</strong> El sistema valida automáticamente que no existan registros duplicados del mismo día
                    </p>
                  </div>
                </div>
              </div>
            ) : (
              <AttendanceHistory 
                records={records} 
                loading={loading} 
                onRefresh={loadAttendanceRecords} 
                userRole={userRole}
                userData={userData}
                onJustify={handleJustification}
              />
            )}
          </main>

          {showScanner && <QRScanner onScan={findStudent} onClose={()=>setShowScanner(false)} />}
          {showManualInput && <ManualInput onSubmit={findStudent} onClose={()=>setShowManualInput(false)} />}
          {selectedStudent && <StudentModal student={selectedStudent} onConfirm={handleConfirmAttendance} onClose={()=>setSelectedStudent(null)} isSubmitting={isSubmitting} userData={userData} />}
          {justificationRecord && <JustificationModal record={justificationRecord} onClose={()=>setJustificationRecord(null)} onSubmit={submitJustification} isSubmitting={isSubmitting} />}

        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);

  </script>

  <script>
    // Renderizar iconos Lucide múltiples veces para asegurar que todos se muestren
    setTimeout(()=> { if (window.lucide) window.lucide.replace(); }, 100);
    setTimeout(()=> { if (window.lucide) window.lucide.replace(); }, 500);
    setTimeout(()=> { if (window.lucide) window.lucide.replace(); }, 1000);
    setTimeout(()=> { if (window.lucide) window.lucide.replace(); }, 2000);
  </script>
</body>
</html>
